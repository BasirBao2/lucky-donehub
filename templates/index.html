<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂåÖÂ≠êÈì∫ - ‰Ω†ÁöÑÂπ∏ËøêÂä†Ê≤πÁ´ô</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/static/favicon_lucky.svg">
    <link rel="alternate icon" href="/static/favicon.svg">
    <link rel="apple-touch-icon" href="/static/favicon_lucky.svg">
    <!-- Emoji favicon fallback for older browsers -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='75'>üé∞</text></svg>">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6B46C1;
            --primary-dark: #553C9A;
            --secondary: #F59E0B;
            --success: #10B981;
            --danger: #EF4444;
            --dark: #1F2937;
            --light: #F9FAFB;
            --border: #E5E7EB;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Inter', 'Noto Sans SC', -apple-system, sans-serif;
            min-height: 100vh;
            background: url('/static/wallpaper-04.jpg') center/cover no-repeat fixed;
            background-color: #2f3163;
            position: relative;
            overflow-x: hidden;
        }

        /* È°∂ÈÉ®ÂØºËà™Ê†è */
        .top-navbar {
            background: linear-gradient(135deg, #4A3B82 0%, #352861 100%);
            padding: 12px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .top-navbar-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 30px;
        }

        .brand-logo {
            color: white;
            font-size: 1.6rem;
            font-weight: 700;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .navbar-actions {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .balance-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 6px 16px;
            border-radius: 20px;
            color: white;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .balance-label {
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
        }

        .balance-amount {
            font-weight: 700;
            font-size: 1.1rem;
            color: #FCD34D;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .btn-topbar {
            background: transparent;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        
        .btn-topbar.active {
            background: linear-gradient(135deg, #F59E0B, #D97706);
            border-color: transparent;
        }

        .btn-topbar:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        
        .btn-topbar.active:hover {
            background: linear-gradient(135deg, #F59E0B, #D97706);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }
        
        .btn-logout {
            background: linear-gradient(135deg, #EF4444, #DC2626);
            border: none;
        }
        
        .btn-logout:hover {
            background: linear-gradient(135deg, #DC2626, #B91C1C);
        }

        .user-info-top {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
        }

        /* ‰∏ªÊ†áÁ≠æÈ°µÂÆπÂô® */
        .main-tabs-container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }

        /* Âà†Èô§‰∫ÜÈ°µÁ≠æÂàáÊç¢Ê†∑ÂºèÔºå‰ΩøÁî®È°∂ÈÉ®ÂØºËà™Ê†è‰ª£Êõø */

        /* ÂÜÖÂÆπÂå∫Âüü */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ÂÜÖÂÆπÂç°Áâá */
        .content-card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-lg);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #F3F4F6;
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-subtitle {
            color: #6B7280;
            font-size: 0.95rem;
            margin-top: 5px;
        }

        /* Á≠æÂà∞Âç°Áâá */
        .sign-card {
            text-align: center;
        }

        .sign-info {
            background: linear-gradient(135deg, #EFF6FF, #DBEAFE);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .sign-status {
            font-size: 1.1rem;
            color: #1E40AF;
            margin-bottom: 10px;
        }

        .sign-reward {
            font-size: 0.95rem;
            color: #6B7280;
        }

        .sign-btn {
            width: 100%;
            padding: 18px;
            font-size: 1.1rem;
            font-weight: 700;
            color: white;
            background: linear-gradient(135deg, #10B981, #059669);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .sign-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
        }

        .sign-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background: #9CA3AF;
        }

        /* ËΩ¨ÁõòÊ†∑Âºè */
        .wheel-container {
            position: relative;
            width: min(100%, 420px);
            max-width: 100%;
            margin: 30px auto;
            aspect-ratio: 1 / 1;
        }

        .wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 40px rgba(102, 126, 234, 0.3);
        }

        #wheelCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .wheel-pointer {
            position: absolute;
            top: clamp(-24px, -6vw, -12px);
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: clamp(12px, 4vw, 22px) solid transparent;
            border-right: clamp(12px, 4vw, 22px) solid transparent;
            border-top: clamp(24px, 7vw, 42px) solid #EF4444;
            filter: drop-shadow(0 0 10px rgba(239, 68, 68, 0.5));
            z-index: 10;
        }

        .wheel-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: clamp(72px, 18vw, 110px);
            height: clamp(72px, 18vw, 110px);
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: 5px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 5;
            box-shadow: 0 0 30px rgba(102, 126, 234, 0.4);
            transition: all 0.3s;
            color: white;
            font-size: clamp(1rem, 4vw, 1.3rem);
            font-weight: 700;
        }

        .wheel-center:hover:not(:disabled) {
            transform: translate(-50%, -50%) scale(1.1);
        }

        .wheel-center:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background: #9CA3AF;
        }

        /* Ê∏∏ÊàèÁªüËÆ° */
        .game-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: #F9FAFB;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .stat-label {
            color: #6B7280;
            font-size: 0.85rem;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-hint {
            margin-top: 8px;
            font-size: 0.8rem;
            color: #6B7280;
        }

        /* ÂéÜÂè≤ËÆ∞ÂΩï */
        .history-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #F3F4F6;
        }

        .history-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .history-item {
            background: #F9FAFB;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .history-item:hover {
            background: #F3F4F6;
            transform: translateX(5px);
        }

        .history-date {
            color: #6B7280;
            font-size: 0.9rem;
        }

        .history-amount {
            font-weight: 600;
            color: var(--success);
        }

        .history-amount.loss {
            color: var(--danger);
        }

        .history-amount small {
            display: block;
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 2px;
        }

        .history-amount.loss small {
            color: var(--danger);
        }

        .extra-purchase-panel {
            margin-top: 16px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }

        .extra-purchase-select {
            min-width: 120px;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-weight: 600;
            color: var(--primary);
            background: white;
        }

        .btn-purchase-extra {
            background: linear-gradient(135deg, #F59E0B, #D97706);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .btn-purchase-extra:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(217, 119, 6, 0.25);
        }

        .btn-purchase-extra:disabled {
            cursor: not-allowed;
            opacity: 0.6;
            background: #D1D5DB;
            color: #6B7280;
            box-shadow: none;
        }

        .extra-purchase-info {
            font-size: 0.85rem;
            color: #6B7280;
        }

        /* Ê∂àÊÅØÊèêÁ§∫ */
        .message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
        }

        .message.success {
            background: #D1FAE5;
            border: 1px solid #6EE7B7;
            color: #065F46;
        }

        .message.error {
            background: #FEE2E2;
            border: 1px solid #FCA5A5;
            color: #991B1B;
        }

        /* Ê¶úÂçïÊ†∑Âºè */
        .leaderboard-section {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .leaderboard-column {
            flex: 1 1 320px;
            background: #F9FAFB;
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 20px;
        }

        .leaderboard-self {
            flex: 1 1 260px;
            background: #111827;
            color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .leaderboard-self-title {
            font-size: 1.05rem;
            font-weight: 600;
        }

        .leaderboard-self-value {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .leaderboard-self-meta {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.75);
        }

        .leaderboard-self-score {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .leaderboard-self-badge {
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 0.04em;
            text-transform: uppercase;
        }

        .leaderboard-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 15px;
        }

        .leaderboard-note {
            margin-top: 16px;
            font-size: 0.85rem;
            color: #6B7280;
        }

        .leaderboard-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px 16px;
            box-shadow: var(--shadow-sm);
        }

        .leaderboard-rank {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, #F59E0B, #D97706);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }

        .leaderboard-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .leaderboard-name {
            font-weight: 600;
            color: var(--dark);
        }

        .leaderboard-meta {
            font-size: 0.85rem;
            color: #6B7280;
        }

        .leaderboard-amount {
            font-weight: 700;
            color: var(--primary);
            min-width: 72px;
            text-align: right;
        }

        .leaderboard-amount.negative {
            color: var(--danger);
        }

        .leaderboard-empty {
            padding: 20px;
            border: 1px dashed var(--border);
            border-radius: 8px;
            text-align: center;
            color: #6B7280;
            background: white;
        }

        /* ÁôªÂΩïÈ°µÈù¢ */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-card {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 450px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-logo {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .login-title {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .login-subtitle {
            color: #6B7280;
            font-size: 0.95rem;
        }

        .login-btn {
            width: 100%;
            padding: 16px;
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .login-features {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid var(--border);
        }

        .feature-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .feature-icon {
            width: 40px;
            height: 40px;
            background: #EFF6FF;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .feature-text {
            color: #4B5563;
            font-size: 0.95rem;
        }

        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 768px) {
            .top-navbar-container {
                flex-direction: column;
                gap: 15px;
            }
            
            .navbar-brand {
                gap: 15px;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .brand-logo {
                font-size: 1.4rem;
            }

            .main-tabs-container {
                padding: 0 10px;
            }

            .tab-btn {
                font-size: 0.9rem;
                padding: 12px 10px;
            }

            .tab-badge {
                display: none;
            }

            .game-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <script id="initialData" type="application/json">{{ initial_data|tojson if logged_in else '{}' }}</script>
    {% if not logged_in %}
    <!-- ÁôªÂΩïÈ°µÈù¢ -->
    <div class="login-container">
        <div class="login-card">
            <div class="login-header">
                <div class="login-logo">üé∞</div>
                <h1 class="login-title">ÂåÖÂ≠êÈì∫</h1>
                <p class="login-subtitle">‰Ω†ÁöÑÂπ∏ËøêÂä†Ê≤πÁ´ô ¬∑ Á≠æÂà∞‰∏éÂ®±‰πêÂπ≥Âè∞</p>
            </div>

            <button class="login-btn" onclick="login()">
                <span>üîê</span>
                <span>‰ΩøÁî® LinuxDo Ë¥¶Âè∑ÁôªÂΩï</span>
            </button>

            <div class="login-features">
                <div class="feature-item">
                    <div class="feature-icon">‚õΩ</div>
                    <div class="feature-text">ÊØèÊó•Á≠æÂà∞È¢ÜÂèñÈ¢ùÂ∫¶Â•ñÂä±</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">üé°</div>
                    <div class="feature-text">Âπ∏ËøêËΩ¨ÁõòËµ¢Âèñ‰∏∞ÂéöÂ§ßÂ•ñ</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">üí∞</div>
                    <div class="feature-text">DoneHub È¢ùÂ∫¶ÂÆûÊó∂Âà∞Ë¥¶</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">üéØ</div>
                    <div class="feature-text">ÂÖ¨Âπ≥ÈÄèÊòéÔºåÂç≥Áé©Âç≥Âæó</div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <!-- È°∂ÈÉ®ÂØºËà™Ê†è -->
    <nav class="top-navbar">
        <div class="top-navbar-container">
            <div class="navbar-brand">
                <a href="/" class="brand-logo">
                    <span>üé∞ ÂåÖÂ≠êÈì∫</span>
                </a>
                <div class="nav-buttons">
                    <button class="btn-topbar active" id="nav-gas" onclick="switchTab('gas')">‚õΩ Âä†Ê≤πÁ´ô</button>
                    <button class="btn-topbar" id="nav-fun" onclick="switchTab('fun')">üéÆ Â®±‰πêÁ´ô</button>
                    <button class="btn-topbar" id="nav-leaderboard" onclick="switchTab('leaderboard')">üèÜ Ê¶úÂçï</button>
                </div>
            </div>
            
            <div class="navbar-actions">
                <div class="balance-info">
                    <span class="balance-label">ÂΩìÂâç‰ΩôÈ¢ù:</span>
                    <span class="balance-amount">$<span id="topBalance">--</span></span>
                </div>
                
                <div class="user-info-top">
                    <div class="user-avatar">{{ user.username[0].upper() }}</div>
                    <span>{{ user.username }}</span>
                </div>
                
                <button class="btn-topbar btn-logout" onclick="logout()">
                    ÈÄÄÂá∫
                </button>
            </div>
        </div>
    </nav>

    <!-- ‰∏ªÂÜÖÂÆπÂå∫Âüü -->
    <div class="main-tabs-container">

        <!-- Âä†Ê≤πÁ´ôÂÜÖÂÆπ -->
        <div class="tab-content active" id="tab-gas">
            <div class="content-card sign-card">
                <div class="card-header">
                    <div>
                        <h2 class="card-title">
                            <span>‚õΩ</span>
                            <span>ÊØèÊó•Á≠æÂà∞Âä†Ê≤πÁ´ô</span>
                        </h2>
                        <p class="card-subtitle">Á≠æÂà∞Ëé∑ÂæóÈöèÊú∫È¢ùÂ∫¶Â•ñÂä±ÔºåÈ¢ùÂ∫¶ÂÆûÊó∂Âà∞Ë¥¶ DoneHub</p>
                    </div>
                </div>

                <div class="sign-info">
                    <div class="sign-status" id="signStatus">ÊØèÊó•Á≠æÂà∞ÂèØËé∑Âæó 50-100 $ÈöèÊú∫Â•ñÂä±</div>
                    <div class="sign-reward">Â∑≤ËøûÁª≠Á≠æÂà∞ <strong id="signStreakCount">0</strong> Â§©</div>
                </div>

                <button class="sign-btn" id="signBtn" onclick="startSign()">
                    <span>‚ö°</span>
                    <span id="signBtnText">Á´ãÂç≥Á≠æÂà∞È¢ÜÂèñÂ•ñÂä±</span>
                </button>

                <div id="signMessage"></div>

                <!-- Á≠æÂà∞ÂéÜÂè≤ -->
                <div class="history-section">
                    <h3 class="history-title">
                        <span>üìú</span>
                        <span>ÊúÄËøëÁ≠æÂà∞ËÆ∞ÂΩï</span>
                    </h3>
                    <div class="history-list" id="signHistory">
                        <div class="history-item">
                            <span class="history-date">ÊöÇÊó†Á≠æÂà∞ËÆ∞ÂΩï</span>
                            <span class="history-amount">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Â®±‰πêÁ´ôÂÜÖÂÆπ -->
        <div class="tab-content" id="tab-fun">
            <div class="content-card">
                <div class="card-header">
                    <div>
                        <h2 class="card-title">
                            <span>üé°</span>
                            <span>Âπ∏ËøêÂ§ßËΩ¨Áõò</span>
                        </h2>
                        <p class="card-subtitle">Ê∂àËÄóÈ¢ùÂ∫¶ÂèÇ‰∏éÊäΩÂ•ñÔºåËµ¢Âèñ‰∏∞ÂéöÂ•ñÂä±</p>
                    </div>
                </div>

                <!-- Ê∏∏ÊàèÁªüËÆ° -->
                <div class="game-stats">
                    <div class="stat-card">
                        <div class="stat-label">‰ªäÊó•Ââ©‰ΩôÊ¨°Êï∞</div>
                        <div class="stat-value"><span id="attemptsLeft">0</span> / <span id="attemptsMax">{{ lottery_max }}</span></div>
                        <div class="stat-hint" id="extraPurchaseHint">ÈªòËÆ§ {{ lottery_max }} Ê¨°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ÂçïÊ¨°Ê∂àËÄó</div>
                        <div class="stat-value">{{ cost_per_spin }} $</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ÊúÄÈ´òÂ•ñÂä±</div>
                        <div class="stat-value">100 $</div>
                    </div>
                </div>

                <div class="extra-purchase-panel">
                    <select class="extra-purchase-select" id="purchaseExtraSelect"></select>
                    <button class="btn-purchase-extra" id="purchaseExtraBtn" type="button">
                        Ë¥≠‰π∞È¢ùÂ§ñÊ¨°Êï∞ ({{ extra_purchase_cost }} $)
                    </button>
                    <div class="extra-purchase-info" id="extraPurchaseInfo">‰ªäÊó•ÊúÄÂ§öÂèØÈ¢ùÂ§ñË¥≠‰π∞ {{ extra_purchase_limit }} Ê¨°</div>
                </div>

                <!-- ËΩ¨ÁõòÂå∫Âüü -->
                <div class="wheel-container">
                    <div class="wheel-pointer"></div>
                    <div class="wheel" id="wheel">
                        <canvas id="wheelCanvas" width="400" height="400"></canvas>
                    </div>
                    <button class="wheel-center" id="spinBtn" onclick="startLottery()">
                        ÂºÄÂßã
                    </button>
                </div>

                <div id="lotteryMessage"></div>

                <!-- ÊäΩÂ•ñÂéÜÂè≤ -->
                <div class="history-section">
                    <h3 class="history-title">
                        <span>üèÜ</span>
                        <span>ÊúÄËøë‰∏≠Â•ñËÆ∞ÂΩï</span>
                    </h3>
                    <div class="history-list" id="lotteryHistory">
                        <div class="history-item">
                            <span class="history-date">ÊöÇÊó†ÊäΩÂ•ñËÆ∞ÂΩï</span>
                            <span class="history-amount">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ‰ªäÊó•Ê¶úÂçï -->
        <div class="tab-content" id="tab-leaderboard">
            <div class="content-card">
                <div class="card-header">
                    <div>
                        <h2 class="card-title">
                            <span>üèÜ</span>
                            <span>‰ªäÊó•Ê¶úÂçï</span>
                        </h2>
                        <p class="card-subtitle">ÁªüËÆ°‰ªäÊó• 00:00 Ëµ∑ÁöÑÊäΩÂ•ñ‰∏≠Â•ñ‰∏éÊâ£Ë¥πÊï∞ÊçÆ</p>
                    </div>
                </div>

                <div class="leaderboard-section">
                    <div class="leaderboard-column">
                        <h3 class="leaderboard-title">ÂáÄÊî∂ÁõäÊ¶ú</h3>
                        <div class="leaderboard-list" id="leaderboardList">
                            <div class="leaderboard-empty">ÊöÇÊó†Êï∞ÊçÆ</div>
                        </div>
                        <div class="leaderboard-note">ÂáÄÊî∂Áõä = ‰ªäÊó•‰∏≠Â•ñÊÄªÈ¢ù - ‰ªäÊó•Êâ£Ë¥πÊÄªÈ¢ù</div>
                    </div>
                    <div class="leaderboard-self" id="leaderboardSelf">
                        <div class="leaderboard-self-badge">ÊàëÁöÑÊî∂Áõä</div>
                        <div class="leaderboard-self-score">
                            <div class="leaderboard-self-title">‰ªäÊó•ÂáÄÊî∂Áõä</div>
                            <div class="leaderboard-self-value" id="leaderboardSelfNet">+0 $</div>
                        </div>
                        <div class="leaderboard-self-meta" id="leaderboardSelfMeta">Â∞öÊú™ÂèÇ‰∏éÊäΩÂ•ñ</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <script>
        const LOTTERY_COST = {{ cost_per_spin }};
        const EXTRA_PURCHASE_COST = {{ extra_purchase_cost }};
        const BASE_DAILY_SPINS = {{ lottery_max }};
        const EXTRA_PURCHASE_LIMIT = {{ extra_purchase_limit }};
        const WHEEL_PRIZES = [
            { amount: 10, color: '#EF4444', label: '10$' },
            { amount: 20, color: '#F97316', label: '20$' },
            { amount: 30, color: '#10B981', label: '30$' },
            { amount: 50, color: '#3B82F6', label: '50$' },
            { amount: 60, color: '#8B5CF6', label: '60$' },
            { amount: 100, color: '#FACC15', label: '100$' }
        ];
        const SLICE_ANGLE = 360 / WHEEL_PRIZES.length;
        const MAX_WHEEL_SIZE = 420;
        const MAX_WHEEL_DRAW_ATTEMPTS = 6;

        let isSpinning = false;
        let currentRotation = 0;
        let pendingResizeRedraw = false;
        let wheelDrawRetry = 0;

        // ÂàùÂßãÂåñÊï∞ÊçÆÔºà‰ªé JSON ËÑöÊú¨ÂÆπÂô®ÂÆâÂÖ®ËØªÂèñÔºâ
        let initialData = (() => {
            const el = document.getElementById('initialData');
            if (!el) return {};
            try { return JSON.parse(el.textContent || '{}'); } catch (e) { return {}; }
        })();

        let dashboardRefreshing = false;

        async function refreshDashboardData() {
            if (!initialData || !initialData.is_authenticated || dashboardRefreshing) return;

            dashboardRefreshing = true;
            try {
                const response = await fetch('/dashboard-data', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    },
                    credentials: 'same-origin'
                });

                if (response.status === 401) {
                    window.location.reload();
                    return;
                }

                if (!response.ok) {
                    console.error('Âà∑Êñ∞Êï∞ÊçÆÂ§±Ë¥•:', response.statusText);
                    return;
                }

                const payload = await response.json();
                if (payload && payload.success && payload.data) {
                    applyDashboardData(payload.data);
                }
            } catch (error) {
                console.error('Âà∑Êñ∞Êï∞ÊçÆÂºÇÂ∏∏:', error);
            } finally {
                dashboardRefreshing = false;
            }
        }

        // TabÂàáÊç¢ÂäüËÉΩ
        function switchTab(tabName) {
            // ÂàáÊç¢ÂØºËà™Ê†èÊåâÈíÆÁä∂ÊÄÅ
            document.querySelectorAll('.btn-topbar').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById('nav-' + tabName)?.classList.add('active');
            
            // ÂàáÊç¢ÂÜÖÂÆπÂå∫Âüü
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById('tab-' + tabName)?.classList.add('active');

            if (tabName === 'fun') {
                requestAnimationFrame(() => drawWheel(true));
            }

            refreshDashboardData();
        }

        // ÁªòÂà∂ËΩ¨Áõò
        function drawWheel(force = false) {
            const canvas = document.getElementById('wheelCanvas');
            if (!canvas) return;
            if (isSpinning && !force) {
                pendingResizeRedraw = true;
                return;
            }
            pendingResizeRedraw = false;
            const container = canvas.parentElement;
            const availableWidth = container ? container.clientWidth : MAX_WHEEL_SIZE;
            const size = Math.min(availableWidth || MAX_WHEEL_SIZE, MAX_WHEEL_SIZE);

            if (!force && (size <= 0 || Number.isNaN(size))) {
                if (wheelDrawRetry < MAX_WHEEL_DRAW_ATTEMPTS) {
                    wheelDrawRetry += 1;
                    setTimeout(() => drawWheel(), 120);
                }
                return;
            }

            if (!force && size < 140 && wheelDrawRetry < MAX_WHEEL_DRAW_ATTEMPTS) {
                wheelDrawRetry += 1;
                setTimeout(() => drawWheel(), 120);
                return;
            }

            wheelDrawRetry = 0;
            const dpr = window.devicePixelRatio || 1;

            canvas.width = size * dpr;
            canvas.height = size * dpr;
            canvas.style.width = `${size}px`;
            canvas.style.height = `${size}px`;

            const ctx = canvas.getContext('2d');
            if (!ctx) return;
            if (ctx.resetTransform) {
                ctx.resetTransform();
            } else {
                ctx.setTransform(1, 0, 0, 1, 0, 0);
            }
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.scale(dpr, dpr);

            const prizes = WHEEL_PRIZES;
            const centerX = size / 2;
            const centerY = size / 2;
            const radius = size / 2 - Math.max(8, size * 0.02);
            const sliceAngle = (Math.PI * 2) / prizes.length;
            const fontSize = Math.max(16, size * 0.065);

            prizes.forEach((prize, index) => {
                const startAngle = index * sliceAngle - Math.PI / 2;
                const endAngle = (index + 1) * sliceAngle - Math.PI / 2;

                // ÁªòÂà∂ÊâáÂΩ¢
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, startAngle, endAngle);
                ctx.lineTo(centerX, centerY);
                ctx.fillStyle = prize.color;
                ctx.fill();

                // ÁªòÂà∂ËæπÊ°Ü
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 3;
                ctx.stroke();

                // ÁªòÂà∂ÊñáÂ≠ó
                ctx.save();
                const textAngle = startAngle + sliceAngle / 2;
                ctx.translate(centerX, centerY);
                ctx.rotate(textAngle);
                ctx.fillStyle = 'white';
                ctx.font = `bold ${fontSize}px Inter`;
                ctx.fillText(prize.label, radius * 0.6, fontSize * 0.3);
                ctx.restore();
            });

            // ÁªòÂà∂‰∏≠ÂøÉÂúÜ
            ctx.beginPath();
            ctx.arc(centerX, centerY, size * 0.13, 0, Math.PI * 2);
            ctx.fillStyle = 'white';
            ctx.fill();
        }

        // ÂàùÂßãÂåñËΩ¨Áõò
        if (document.getElementById('wheelCanvas')) {
            drawWheel();
        }

        let wheelResizeTimer = null;
        window.addEventListener('resize', () => {
            clearTimeout(wheelResizeTimer);
            wheelResizeTimer = setTimeout(() => {
                drawWheel();
            }, 200);
        });

        // Êõ¥Êñ∞‰ΩôÈ¢ùÊòæÁ§∫
        function updateBalanceDisplay(balance) {
            if (balance === undefined || balance === null) return;
            const numeric = Number(balance);
            if (Number.isNaN(numeric)) return;
            const normalized = numeric.toFixed(2);
            
            const topBalance = document.getElementById('topBalance');
            const statsBalance = document.getElementById('statsBalance');
            
            if (topBalance) topBalance.textContent = normalized;
            if (statsBalance) statsBalance.textContent = normalized;
        }

        const MS_PER_DAY = 24 * 60 * 60 * 1000;

        const normalizeDate = (value) => {
            if (!value) return null;
            const date = value instanceof Date ? value : new Date(value);
            if (Number.isNaN(date.getTime())) return null;
            return new Date(date.getFullYear(), date.getMonth(), date.getDate());
        };

        const calculateSignStreak = (history) => {
            if (!Array.isArray(history) || !history.length) return 0;
            const parsed = history
                .map(item => normalizeDate(item?.sign_date))
                .filter(Boolean)
                .sort((a, b) => b.getTime() - a.getTime());
            if (!parsed.length) return 0;

            let streak = 0;
            let expected = new Date(parsed[0].getTime());

            for (const date of parsed) {
                const current = normalizeDate(date);
                if (!current) continue;
                const diff = Math.round((expected.getTime() - current.getTime()) / MS_PER_DAY);
                if (diff === 0) {
                    streak += 1;
                    expected = new Date(expected.getTime() - MS_PER_DAY);
                } else if (diff > 0) {
                    break;
                } else if (diff < 0) {
                    expected = new Date(current.getTime());
                }
            }
            return streak;
        };

        const updateSignStreakDisplay = (history) => {
            const streakEl = document.getElementById('signStreakCount');
            if (!streakEl) return;
            const streak = calculateSignStreak(history);
            streakEl.textContent = streak;
        };

        // Êõ¥Êñ∞Á≠æÂà∞ÂéÜÂè≤
        function updateSignHistory(history) {
            const container = document.getElementById('signHistory');
            if (!container) return;

            container.innerHTML = '';
            if (!history || !history.length) {
                container.innerHTML = '<div class="history-item"><span class="history-date">ÊöÇÊó†Á≠æÂà∞ËÆ∞ÂΩï</span><span class="history-amount">--</span></div>';
                updateSignStreakDisplay([]);
                return;
            }

            history.forEach(item => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `
                    <span class="history-date">${item.sign_date}</span>
                    <span class="history-amount">+${item.reward} $</span>
                `;
                container.appendChild(div);
            });

            updateSignStreakDisplay(history);
        }

        // Êõ¥Êñ∞ÊäΩÂ•ñÂéÜÂè≤
        function updateLotteryHistory(history) {
            const container = document.getElementById('lotteryHistory');
            if (!container) return;
            
            container.innerHTML = '';
            if (!history || !history.length) {
                container.innerHTML = '<div class="history-item"><span class="history-date">ÊöÇÊó†ÊäΩÂ•ñËÆ∞ÂΩï</span><span class="history-amount">--</span></div>';
                return;
            }
            
            history.forEach(item => {
                const div = document.createElement('div');
                div.className = 'history-item';
                const prizeValue = item.quota ?? 0;
                const netAmount = prizeValue - (item.cost ?? LOTTERY_COST);
                const amountClass = netAmount >= 0 ? 'history-amount' : 'history-amount loss';
                const netText = `ÂáÄ${netAmount >= 0 ? '+' : ''}${netAmount} $`;
                div.innerHTML = `
                    <span class="history-date">${item.lottery_date || ''}</span>
                    <span class="${amountClass}">+${prizeValue} $<small>${netText}</small></span>
                `;
                container.appendChild(div);
            });
        }

        function renderLeaderboard(data, selfInfo) {
            const container = document.getElementById('leaderboardList');
            if (container) {
                container.innerHTML = '';

                if (!Array.isArray(data) || !data.length) {
                    container.innerHTML = '<div class="leaderboard-empty">ÊöÇÊó†Êï∞ÊçÆ</div>';
                } else {
                    data.forEach((item, index) => {
                        const name = item?.username || 'Êú™Áü•Áî®Êà∑';
                        const attempts = Number(item?.attempts ?? 0);
                        const totalPrize = Number(item?.total_prize ?? 0);
                        const totalCost = Number(item?.total_cost ?? 0);
                        const net = Number(item?.net_change ?? 0);

                        const row = document.createElement('div');
                        row.className = 'leaderboard-item';

                        const rankEl = document.createElement('span');
                        rankEl.className = 'leaderboard-rank';
                        rankEl.textContent = String(index + 1);

                        const infoEl = document.createElement('div');
                        infoEl.className = 'leaderboard-info';

                        const nameEl = document.createElement('div');
                        nameEl.className = 'leaderboard-name';
                        nameEl.textContent = name;

                        const metaEl = document.createElement('div');
                        metaEl.className = 'leaderboard-meta';
                        metaEl.textContent = `‰∏≠Â•ñ ${totalPrize.toFixed(0)} $ ¬∑ Êâ£Ë¥π ${totalCost.toFixed(0)} $ ¬∑ ${Math.max(0, attempts)} Ê¨°`;

                        infoEl.appendChild(nameEl);
                        infoEl.appendChild(metaEl);

                        const amountEl = document.createElement('span');
                        amountEl.className = net >= 0 ? 'leaderboard-amount' : 'leaderboard-amount negative';
                        amountEl.textContent = `${net >= 0 ? '+' : ''}${net.toFixed(0)} $`;

                        row.appendChild(rankEl);
                        row.appendChild(infoEl);
                        row.appendChild(amountEl);

                        container.appendChild(row);
                    });
                }
            }

            const selfNetEl = document.getElementById('leaderboardSelfNet');
            const selfMetaEl = document.getElementById('leaderboardSelfMeta');
            if (selfNetEl && selfMetaEl) {
                const net = Number(selfInfo?.net_change ?? 0);
                const totalPrize = Number(selfInfo?.total_quota ?? 0);
                const totalCost = Number(selfInfo?.total_cost ?? 0);
                const attempts = Number(selfInfo?.attempts ?? 0);

                selfNetEl.textContent = `${net >= 0 ? '+' : ''}${net.toFixed(0)} $`;
                selfNetEl.style.color = net >= 0 ? '#34D399' : '#F87171';

                if (attempts > 0) {
                    selfMetaEl.textContent = `‰∏≠Â•ñ ${totalPrize.toFixed(0)} $ ¬∑ Êâ£Ë¥π ${totalCost.toFixed(0)} $ ¬∑ ${attempts} Ê¨°`;
                } else {
                    selfMetaEl.textContent = '‰ªäÊó•Â∞öÊú™ÂèÇ‰∏éÊäΩÂ•ñ';
                }
            }
        }

        function updatePurchaseButtonLabel(purchaseCost, remainingPurchases) {
            const purchaseBtn = document.getElementById('purchaseExtraBtn');
            const purchaseSelect = document.getElementById('purchaseExtraSelect');
            if (!purchaseBtn) return;

            if (remainingPurchases <= 0) {
                purchaseBtn.disabled = true;
                purchaseBtn.textContent = '‰ªäÊó•Ë¥≠‰π∞Â∑≤Ëææ‰∏äÈôê';
                return;
            }

            const selected = Math.max(1, Math.min(remainingPurchases, Number(purchaseSelect?.value ?? 1)));
            const totalCost = purchaseCost * selected;
            purchaseBtn.disabled = false;
            purchaseBtn.textContent = `Ë¥≠‰π∞È¢ùÂ§ñ ${selected} Ê¨° (${purchaseCost} $ √ó ${selected} = ${totalCost} $)`;
        }

        let latestLotteryData = null;

        function updateLotterySummaryUI(lottery) {
            if (!lottery) return;
            latestLotteryData = lottery;

            const attemptsLeftEl = document.getElementById('attemptsLeft');
            const attemptsMaxEl = document.getElementById('attemptsMax');
            const hintEl = document.getElementById('extraPurchaseHint');
            const infoEl = document.getElementById('extraPurchaseInfo');
            const purchaseBtn = document.getElementById('purchaseExtraBtn');
            const purchaseSelect = document.getElementById('purchaseExtraSelect');

            const remaining = Number(lottery.remaining_attempts ?? 0);
            const maxAttempts = Number(lottery.max_attempts ?? BASE_DAILY_SPINS);
            const baseAttempts = Number(lottery.base_attempts ?? BASE_DAILY_SPINS);
            const extraPurchased = Number(lottery.extra_purchased ?? 0);
            const purchaseLimit = Number(lottery.extra_purchase_limit ?? EXTRA_PURCHASE_LIMIT);
            const purchaseCost = Number(lottery.extra_purchase_cost ?? EXTRA_PURCHASE_COST);
            const remainingPurchases = Math.max(0, purchaseLimit - extraPurchased);

            if (attemptsLeftEl) attemptsLeftEl.textContent = remaining;
            if (attemptsMaxEl) attemptsMaxEl.textContent = maxAttempts;
            if (hintEl) hintEl.textContent = `ÈªòËÆ§ ${baseAttempts} Ê¨°ÔºåÂèØÈ¢ùÂ§ñË¥≠‰π∞ ${purchaseLimit} Ê¨°`;
            if (infoEl) infoEl.textContent = `Â∑≤Ë¥≠ ${extraPurchased} Ê¨° / ÂèØË¥≠ ${purchaseLimit} Ê¨°`;

            if (purchaseSelect) {
                const currentValue = purchaseSelect.value;
                purchaseSelect.innerHTML = '';
                for (let i = 1; i <= remainingPurchases; i += 1) {
                    const option = document.createElement('option');
                    option.value = String(i);
                    option.textContent = `${i} Ê¨°`;
                    purchaseSelect.appendChild(option);
                }
                if (remainingPurchases === 0) {
                    const option = document.createElement('option');
                    option.value = '0';
                    option.textContent = 'Â∑≤Ëææ‰∏äÈôê';
                    purchaseSelect.appendChild(option);
                }

                if (currentValue && Number(currentValue) <= remainingPurchases && Number(currentValue) > 0) {
                    purchaseSelect.value = currentValue;
                } else if (remainingPurchases > 0) {
                    purchaseSelect.value = '1';
                } else {
                    purchaseSelect.value = '0';
                }

                purchaseSelect.disabled = remainingPurchases <= 0;
            }

            updatePurchaseButtonLabel(purchaseCost, remainingPurchases);
        }

        function applyDashboardData(data) {
            if (!data || !data.is_authenticated) return;

            initialData = data;

            if (data.balance !== undefined) {
                updateBalanceDisplay(data.balance);
            }

            if (data.sign) {
                const todaySigned = Boolean(data.sign.today_signed);
                const signBtn = document.getElementById('signBtn');
                const signBtnText = document.getElementById('signBtnText');
                if (signBtn && signBtnText) {
                    signBtn.disabled = todaySigned;
                    signBtnText.textContent = todaySigned ? '‰ªäÊó•Â∑≤Á≠æÂà∞' : 'Á´ãÂç≥Á≠æÂà∞È¢ÜÂèñÂ•ñÂä±';
                }
                updateSignHistory(data.sign.history);
            }

            if (data.lottery) {
                updateLotteryHistory(data.lottery.history);
                updateLotterySummaryUI(data.lottery);
            }

            renderLeaderboard(
                Array.isArray(data.leaderboard) ? data.leaderboard : [],
                data.leaderboard_self || null
            );
        }

        applyDashboardData(initialData);

        // ÁôªÂΩï/ÈÄÄÂá∫ÂäüËÉΩ
        function login() {
            window.location.href = '/login';
        }

        function logout() {
            window.location.href = '/logout';
        }

        // Á≠æÂà∞ÂäüËÉΩ
        async function startSign() {
            const btn = document.getElementById('signBtn');
            const btnText = document.getElementById('signBtnText');
            const message = document.getElementById('signMessage');
            
            btn.disabled = true;
            btnText.textContent = 'Á≠æÂà∞‰∏≠...';
            if (message) message.innerHTML = '';
            
            try {
                const response = await fetch('/sign', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    btnText.textContent = '‰ªäÊó•Â∑≤Á≠æÂà∞';
                    if (message) {
                        message.className = 'message success';
                        message.textContent = data.message;
                    }
                    
                    if (data.current_balance !== undefined) {
                        updateBalanceDisplay(data.current_balance);
                    }
                    updateSignHistory(data.sign_history);
                    refreshDashboardData();
                } else {
                    if (message) {
                        message.className = 'message error';
                        message.textContent = data.message;
                    }
                    
                    if (data.code !== 'ALREADY_SIGNED') {
                        btn.disabled = false;
                        btnText.textContent = 'Á´ãÂç≥Á≠æÂà∞È¢ÜÂèñÂ•ñÂä±';
                    } else {
                        btnText.textContent = '‰ªäÊó•Â∑≤Á≠æÂà∞';
                    }
                }
            } catch (error) {
                if (message) {
                    message.className = 'message error';
                    message.textContent = 'Á≠æÂà∞Â§±Ë¥•ÔºåËØ∑Á®çÂêéÂÜçËØï';
                }
                btn.disabled = false;
                btnText.textContent = 'Á´ãÂç≥Á≠æÂà∞È¢ÜÂèñÂ•ñÂä±';
                console.error('Á≠æÂà∞ÈîôËØØ:', error);
            }
        }

        async function startLottery() {
            if (isSpinning) return;

            const btn = document.getElementById('spinBtn');
            const wheel = document.getElementById('wheel');
            const message = document.getElementById('lotteryMessage');

            isSpinning = true;
            btn.disabled = true;
            btn.textContent = 'ÊäΩÂ•ñ‰∏≠...';
            if (message) message.innerHTML = '';

            const spinStartTime = performance.now();
            const MIN_SPIN_TIME = 1500; // Á°Æ‰øùËá≥Â∞ëÊóãËΩ¨Ëøô‰πà‰πÖ
            let continuousRAF = null;
            let continuousActive = false;

            const waitForMinimumSpin = () => {
                const elapsed = performance.now() - spinStartTime;
                if (elapsed >= MIN_SPIN_TIME) return Promise.resolve();
                return new Promise(resolve => setTimeout(resolve, MIN_SPIN_TIME - elapsed));
            };

            const stopContinuousSpin = () => {
                if (!continuousActive) return;
                continuousActive = false;
                if (continuousRAF) cancelAnimationFrame(continuousRAF);
                continuousRAF = null;
            };

            const startContinuousSpin = () => {
                continuousActive = true;
                wheel.style.transition = 'none';
                let last = performance.now();
                const speed = 720; // ÊØèÁßíÊóãËΩ¨Â∫¶Êï∞
                const step = (now) => {
                    if (!continuousActive) return;
                    const delta = now - last;
                    last = now;
                    currentRotation += (speed * delta) / 1000;
                    wheel.style.transform = `rotate(${currentRotation}deg)`;
                    continuousRAF = requestAnimationFrame(step);
                };
                continuousRAF = requestAnimationFrame(step);
            };

            const finishWithError = async (
                errorMessage = 'ÊäΩÂ•ñÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï',
                keepDisabled = false,
                buttonLabel = 'ÂºÄÂßã'
            ) => {
                await waitForMinimumSpin();
                stopContinuousSpin();
                if (message) {
                    message.className = 'message error';
                    message.textContent = errorMessage;
                }
                btn.textContent = buttonLabel;
                btn.disabled = !!keepDisabled;
                isSpinning = false;
                if (pendingResizeRedraw) {
                    pendingResizeRedraw = false;
                    drawWheel(true);
                }
            };

            // Â∑•ÂÖ∑ÂáΩÊï∞ÔºöÊî∂Â∞æÂä®Áîª
            const startSettleSpin = async (data) => {
                await waitForMinimumSpin();
                stopContinuousSpin();

                const prizeIndex = Math.max(0, WHEEL_PRIZES.findIndex(p => p.amount === data.quota));
                const normalizedCurrent = ((currentRotation % 360) + 360) % 360;
                const randomOffset = (Math.random() - 0.5) * SLICE_ANGLE * 0.4;
                const targetAngle = (360 - (prizeIndex * SLICE_ANGLE + SLICE_ANGLE / 2) + randomOffset + 360) % 360;
                const baseSpins = 4;
                let extraRotation = (targetAngle - normalizedCurrent + 360) % 360;
                extraRotation += baseSpins * 360;
                const finalRotation = currentRotation + extraRotation;
                const settleDuration = 1800;

                wheel.style.transition = 'none';
                wheel.style.transform = `rotate(${currentRotation}deg)`;
                void wheel.offsetWidth;
                requestAnimationFrame(() => {
                    wheel.style.transition = `transform ${settleDuration}ms cubic-bezier(0.23, 1, 0.32, 1)`;
                    wheel.style.transform = `rotate(${finalRotation}deg)`;
                });
                currentRotation = finalRotation;

                setTimeout(() => {
                    if (data.current_balance !== undefined) updateBalanceDisplay(data.current_balance);
                    const attemptsLeft = document.getElementById('attemptsLeft');
                    if (attemptsLeft && data.remaining_attempts !== undefined) attemptsLeft.textContent = data.remaining_attempts;
                    updateLotteryHistory(data.lottery_history);
                    if (message) {
                        const net = (data.quota ?? 0) - LOTTERY_COST;
                        const netText = `ÂáÄ${net >= 0 ? '+' : ''}${net} $`;
                        message.className = 'message success';
                        message.innerHTML = `üéâ ÊÅ≠ÂñúËé∑Âæó ${data.quota} $Â•ñÂä±ÔºÅ<br><small>${netText}</small>`;
                    }
                    btn.disabled = false;
                    btn.textContent = 'ÂºÄÂßã';
                    isSpinning = false;
                    refreshDashboardData();
                    if (pendingResizeRedraw) {
                        pendingResizeRedraw = false;
                        drawWheel(true);
                    }
                }, settleDuration);
            };

            startContinuousSpin();

            try {
                const response = await fetch('/lottery', { method: 'POST' });
                const data = await response.json();

                if (!data.success) {
                    const isUserMissing = data.code === 'USER_NOT_FOUND';
                    const isInsufficient = data.code === 'INSUFFICIENT_FUNDS';
                    let buttonLabel = 'ÂºÄÂßã';
                    let keepDisabled = false;
                    let msg = data.message || 'ÊäΩÂ•ñÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï';

                    if (isUserMissing) {
                        buttonLabel = 'Ë¥¶Âè∑Êú™ÁªëÂÆö';
                        keepDisabled = true;
                        msg = data.message || 'Ë¥¶Âè∑Êú™ÁªëÂÆöÔºåÊó†Ê≥ïÊäΩÂ•ñ';
                    } else if (isInsufficient) {
                        buttonLabel = '‰ΩôÈ¢ù‰∏çË∂≥';
                        keepDisabled = true;
                        msg = data.message || '‰ΩôÈ¢ù‰∏çË∂≥ÔºåÊó†Ê≥ïÊäΩÂ•ñ';
                    }

                    await finishWithError(msg, keepDisabled, buttonLabel);
                    return;
                }

                await startSettleSpin(data);
            } catch (error) {
                console.error('ÊäΩÂ•ñÈîôËØØ:', error);
                await finishWithError('ÊäΩÂ•ñÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï');
            }
        }

        async function purchaseExtraAttempt() {
            const btn = document.getElementById('purchaseExtraBtn');
            const message = document.getElementById('lotteryMessage');
            const purchaseSelect = document.getElementById('purchaseExtraSelect');
            if (!btn) return;

            if (btn.disabled && btn.textContent === '‰ªäÊó•Ë¥≠‰π∞Â∑≤Ëææ‰∏äÈôê') {
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Ë¥≠‰π∞‰∏≠...';
            if (message) {
                message.className = '';
                message.textContent = '';
            }

            const quantity = Math.max(1, Number(purchaseSelect?.value ?? 1));

            try {
                const response = await fetch('/lottery/purchase', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ quantity })
                });
                const data = await response.json().catch(() => ({}));

                if (response.ok && data?.success) {
                    if (message) {
                        message.className = 'message success';
                        message.textContent = data.message || `Ë¥≠‰π∞ÊàêÂäüÔºåÂ∑≤Â¢ûÂä† ${quantity} Ê¨°ÊäΩÂ•ñÊú∫‰ºö`;
                    }

                    if (data.data) {
                        applyDashboardData(data.data);
                    } else {
                        refreshDashboardData();
                    }
                } else {
                    const errorMsg = data?.message || 'Ë¥≠‰π∞Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï';
                    if (message) {
                        message.className = 'message error';
                        message.textContent = errorMsg;
                    }
                    btn.disabled = false;
                    const remainingPurchases = Math.max(
                        0,
                        ((latestLotteryData?.extra_purchase_limit ?? EXTRA_PURCHASE_LIMIT) - (latestLotteryData?.extra_purchased ?? 0))
                    );
                    const purchaseCost = Number(latestLotteryData?.extra_purchase_cost ?? EXTRA_PURCHASE_COST);
                    updatePurchaseButtonLabel(purchaseCost, remainingPurchases);
                }
            } catch (error) {
                console.error('Ë¥≠‰π∞È¢ùÂ§ñÊ¨°Êï∞Â§±Ë¥•:', error);
                if (message) {
                    message.className = 'message error';
                    message.textContent = 'Ë¥≠‰π∞Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï';
                }
                btn.disabled = false;
                const remainingPurchases = Math.max(
                    0,
                    ((latestLotteryData?.extra_purchase_limit ?? EXTRA_PURCHASE_LIMIT) - (latestLotteryData?.extra_purchased ?? 0))
                );
                const purchaseCost = Number(latestLotteryData?.extra_purchase_cost ?? EXTRA_PURCHASE_COST);
                updatePurchaseButtonLabel(purchaseCost, remainingPurchases);
            }
        }

        const purchaseBtn = document.getElementById('purchaseExtraBtn');
        if (purchaseBtn) {
            purchaseBtn.addEventListener('click', purchaseExtraAttempt);
        }

        const purchaseSelect = document.getElementById('purchaseExtraSelect');
        if (purchaseSelect) {
            purchaseSelect.addEventListener('change', () => {
                const remainingPurchases = Math.max(
                    0,
                    ((latestLotteryData?.extra_purchase_limit ?? EXTRA_PURCHASE_LIMIT) - (latestLotteryData?.extra_purchased ?? 0))
                );
                const purchaseCost = Number(latestLotteryData?.extra_purchase_cost ?? EXTRA_PURCHASE_COST);
                updatePurchaseButtonLabel(purchaseCost, remainingPurchases);
            });
        }

        // ÁªëÂÆöÂÖ®Â±ÄÂáΩÊï∞
        window.login = login;
        window.logout = logout;
        window.startSign = startSign;
        window.startLottery = startLottery;
        window.switchTab = switchTab;
        window.purchaseExtraAttempt = purchaseExtraAttempt;
    </script>
</body>
</html>
